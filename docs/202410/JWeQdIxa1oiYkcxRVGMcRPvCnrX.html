<h1>æ‰‹æŠŠæ‰‹æ•™ä½ ï¼Œå…è´¹ä½¿ç”¨Fluxå›¾ç‰‡ç”Ÿæˆæ¨¡å‹</h1>
<blockquote>æ¥æºï¼š<a href="https://y3my0b87ql.feishu.cn/docx/JWeQdIxa1oiYkcxRVGMcRPvCnrX">https://y3my0b87ql.feishu.cn/docx/JWeQdIxa1oiYkcxRVGMcRPvCnrX</a></blockquote>
<p>çœ‹åˆ°ç”Ÿè´¢æœ‰åœˆå‹åˆ†äº«äº†ï¼Œå…³äºç”¨fluxæ¥ç”Ÿæˆå°çº¢ä¹¦ï¼Œå…¬ä¼—å·ç­‰å¹³å°çš„å›¾ç‰‡ï¼Œæˆ–è€…ç”¨å›¾ç‰‡ç”Ÿæˆå›¾ç‰‡çš„æ•™ç¨‹ï¼Œä½†æ˜¯é‡Œé¢çš„flux apiå·²ç»è¿‡æœŸäº†ï¼Œå¸Œæœ›è¿™ä¸ªCF å…è´¹çš„æ¥å£å¯ä»¥åŠ©åŠ›å¤§å®¶ã€‚</p>
<h1>FLUX æ˜¯ä»€ä¹ˆï¼Ÿ</h1>

<p>å¯ä»¥ç†è§£ä¸ºå¼€æºç‰ˆçš„midjourneyã€‚ ç”Ÿæˆå›¾ç‰‡çš„è´¨é‡é«˜ã€‚</p>
<p>ç¤¾åŒºæœ‰å¾ˆå¤šè¿™æ ·çš„æ¡ˆä¾‹ã€‚</p>

<p>Flux AIæ¨¡å‹ï¼šåœ¨äººå·¥æ™ºèƒ½é¢†åŸŸï¼ŒFluxå¯èƒ½æŒ‡çš„æ˜¯ç”±Black Forest Labsæ¨å‡ºçš„å¼€æºAIå›¾åƒç”Ÿæˆæ¨¡å‹FLUX.1ã€‚è¿™ä¸ªæ¨¡å‹æ‹¥æœ‰12Bå‚æ•°ï¼Œæ˜¯è¿„ä»Šä¸ºæ­¢æœ€å¤§çš„æ–‡ç”Ÿå›¾æ¨¡å‹ä¹‹ä¸€ã€‚</p>

<p>å®ƒåŒ…å«ä¸‰ç§å˜ä½“ï¼šFLUX.1 [pro]ã€FLUX.1 [dev] å’Œ FLUX.1 [schnell]ï¼Œåˆ†åˆ«é’ˆå¯¹ä¸åŒçš„ä½¿ç”¨åœºæ™¯å’Œæ€§èƒ½éœ€æ±‚.</p>

<p>å¯¹äºç¤¾åŒºåŠçš„ï¼Œschnellæ˜¯å…è´¹çš„ã€‚</p>

<h1>å‡†å¤‡è´¦å·</h1>

<p>åªéœ€è¦æ³¨å†Œä¸€ä¸ªcloudflareè´¦å·å³å¯ï¼Œè´¦å†Œè´¦å·ç•¥ã€‚ æ²¡æœ‰æ¡ä»¶çš„ä¹Ÿå¯ä»¥ç›´æ¥å»æ·˜å®è´­ä¹°ã€‚</p>

<h1>æ­å»ºFlux work ai</h1>

<p>æœ¬æ¥æ˜¯ä¸ºäº†æä¾›å¤§å®¶ç ”ç©¶å’Œä½“éªŒï¼Œä½†æ˜¯ä¹Ÿå¯ä»¥ç”¨äºå…¶ä»–çš„éä½“æ£€ã€‚</p>

<p>æˆ‘æ‰¾äº†ä¸ºå•¥å¯ä»¥ä½¿ç”¨è¿™äº›èµ„æº?</p>

<p>Cloudflareèƒ½å¤Ÿæä¾›å¤§é‡çš„å¼€æºAIæ¨¡å‹æ¥ä½¿ç”¨ï¼Œå…¶ç®—åŠ›ä¸»è¦æ¥æºäºå…¶å…¨çƒåˆ†å¸ƒçš„æ•°æ®ä¸­å¿ƒå’Œåˆä½œä¼™ä¼´æä¾›çš„èµ„æºã€‚Cloudflareåœ¨å…¨çƒæ‹¥æœ‰å¹¿æ³›çš„ç½‘ç»œåŸºç¡€è®¾æ–½ï¼ŒåŒ…æ‹¬åˆ†å¸ƒåœ¨100å¤šä¸ªå›½å®¶çš„æ•°æ®ä¸­å¿ƒï¼Œè¿™äº›æ•°æ®ä¸­å¿ƒé…å¤‡äº†é«˜æ€§èƒ½çš„æœåŠ¡å™¨å’ŒGPUï¼Œèƒ½å¤Ÿæä¾›å¼ºå¤§çš„è®¡ç®—èƒ½åŠ›æ¥æ”¯æŒAIæ¨¡å‹çš„è¿è¡Œã€‚æ­¤å¤–ï¼ŒCloudflareè¿˜ä¸Nvidiaç­‰ç¡¬ä»¶ä¾›åº”å•†åˆä½œï¼Œåˆ©ç”¨å…¶GPUèµ„æºæ¥æä¾›AIæœåŠ¡ã€‚</p>

<p>æœ‰äº›ä¸ºäº†æ•™è‚²äº§å“ï¼Œåªæœ‰è€å¸ˆå’Œå­¦ç”Ÿå¯ä»¥æœ‰èµ„æ ¼ï¼Œä½†æ˜¯æœ‰äº†æ•™å¸ˆè¯å’Œå­¦ç”Ÿè¯ç†è®ºä¸Šéƒ½å¯ä»¥è´­ä¹°ã€‚å¤§æ¦‚å’Œè¿™ä¸ªæ€è·¯å·®ä¸å¤šã€‚</p>

<p>è‚¥è¯ä¸€å †ï¼Œå¥½äº†å¼€å§‹æã€‚</p>
<h2>ç™»å½•cloudflare</h2>
<p>ç‚¹å‡»ç½‘ç«™ï¼Œ ç„¶åå³ä¸Šè§’çš„login</p>
<p>https://cloudflare.com</p>

<h2>è·å–éœ€è¦çš„cfid</h2>

<p>cfidï¼Œå°±æ˜¯ç™»å½•ä¹‹åï¼Œåœ°å€æ çš„urlï¼Œåé¢é‚£ä¸€ä¸²æ•°å­—å°±æ˜¯ï¼š</p>
<p><img src="img/aa71a719133712894ed8355067185201.png" data-original-src="https://internal-api-drive-stream.feishu.cn/space/api/box/stream/download/v2/cover/L1ldbZeQvocUHlx0YoIcoJhpnye/"/></p>
<p>ä¹Ÿå¯ä»¥åœ¨è¿™é‡Œçœ‹åˆ°ã€‚ç‚¹å‡»å·¦ä¾§çš„workerï¼Œç„¶åå†å³è¾¹å¯ä»¥çœ‹åˆ°ã€‚</p>
<p><img src="img/833193c9590f65e2d9c86f853f11ae76.png" data-original-src="https://internal-api-drive-stream.feishu.cn/space/api/box/stream/download/v2/cover/BFwgbNeExoLWtixorHIcXafInMb/"/></p>
<h2>é…ç½®api key</h2>
<p>ç‚¹å‡»å³ä¸Šè§’ï¼Œæˆ‘çš„ï¼Œç„¶åç‚¹å‡»token</p>
<p>https://dash.cloudflare.com/profile/api-tokens</p>
<p><img src="img/b40c1a716b6662ab2f66ce28dccccd53.png" data-original-src="https://internal-api-drive-stream.feishu.cn/space/api/box/stream/download/v2/cover/RBdBb80zZomtD1xFgTWc0H7Nn5e/"/></p>
<p>è¿™é‡Œä¸€å®šè¦é€‰æ‹© workers AI</p>
<p><img src="img/ed058d9ec02df73cdd09579aa7c0deca.png" data-original-src="https://internal-api-drive-stream.feishu.cn/space/api/box/stream/download/v2/cover/U51RbF0DJoxbJzx6Cj4cATPSn1d/"/></p>

<p>ç„¶åè¿™é‡Œè´¦å·ï¼Œé€‰æ‹©æ‰€æœ‰å³å¯ã€‚</p>
<p><img src="img/87d294ce01d253dd916247037ecd4cda.png" data-original-src="https://internal-api-drive-stream.feishu.cn/space/api/box/stream/download/v2/cover/Mva5buGG7oURUcxWRTEcTj9Inaf/"/></p>
<p>ç„¶åä¸‹ä¸€æ­¥ï¼Œ ä¸‹ä¸€æ­¥</p>
<p>å°±å®Œæˆäº†ã€‚</p>

<h2>åˆ›å»ºä¸€ä¸ªKV</h2>

<p>å·¦ä¾§é‚®ä»¶workerï¼Œ é‡Œé¢æœ‰ä¸€ä¸ªKVï¼Œè¿™ä¸ªç”¨æ¥å­˜å‚¨å›¾ç‰‡çš„ã€‚</p>
<p><img src="img/de53dfb76876b67f4ab9bc1d04cc5ea9.png" data-original-src="https://internal-api-drive-stream.feishu.cn/space/api/box/stream/download/v2/cover/ZBKabmw2RoY3fhx8xmEcMMYhnWg/"/></p>
<p>åå­— ç”¨IMAGE_KVå³å¯ã€‚ç‚¹å‡»ç¡®å®šã€‚</p>
<p><img src="img/98a02daa493ff1d36254abc34c7996db.png" data-original-src="https://internal-api-drive-stream.feishu.cn/space/api/box/stream/download/v2/cover/MswwbJCWzormBLxXlr0cIFLNnSb/"/></p>
<h2>åˆ›å»ºworkers</h2>
<p>ç‚¹å‡»workersï¼Œ ç„¶åcreateï¼Œ</p>
<p><img src="img/6c491b44091600b576c4cb4010e73561.png" data-original-src="https://internal-api-drive-stream.feishu.cn/space/api/box/stream/download/v2/cover/EbrPbQQZCof44exSN7Nc3r7InOd/"/></p>
<p>ç‚¹å‡» åˆ›å»º</p>
<p><img src="img/dad2ad23dba85ab8a7df10af067f0b7b.png" data-original-src="https://internal-api-drive-stream.feishu.cn/space/api/box/stream/download/v2/cover/YmeSbAC7uofvl3xw05HcO5rhnXb/"/></p>
<p>éšä¾¿å–ä¸€ä¸ªåå­—ï¼šï¼Œç„¶åæ„å»º</p>
<p><img src="img/87a5b7e080e2876ae73677cb3e628ccc.png" data-original-src="https://internal-api-drive-stream.feishu.cn/space/api/box/stream/download/v2/cover/Rvu4bY9CaoT0kAxQhQ5cN4ODnLf/"/></p>
<p>ç‚¹å‡»ç¼–è¾‘code</p>
<p><img src="img/669d4b65bd18d121e12eaf84b1688bad.png" data-original-src="https://internal-api-drive-stream.feishu.cn/space/api/box/stream/download/v2/cover/SyoFbhPKNo10ADxAbpVc1lOOn9b/"/></p>
<p>ç„¶åæŠŠä¸‹é¢å’Œè¿™ä¸ªä»£ç å¤åˆ¶è¿›å»ï¼š</p>
<p>éœ€è¦ä¿®æ”¹ï¼šapi_keyï¼Œéšä¾¿è¾“å…¥</p>
<p>cfidï¼š ç¬¬ä¸€æ­¥è·å–çš„å€¼</p>
<p>api_tokenï¼šç¬¬äºŒæ­¥ï¼Œè‡ªå·±é…ç½®çš„</p>

<p>ä¸‹é¢çš„ä»£ç æ¥è‡ªLç«™çš„å¤§ä½¬æä¾›çš„ã€‚</p>
<pre>// é…ç½®
const CONFIG = {
  API_KEY: "sk-1111",  //å¯¹å¤–éªŒè¯key
  CF_ACCOUNT_LIST: [{ account_id: "cfid", token: "api_token" }],  //æ”¹æˆè‡ªå·±çš„
  CF_IS_TRANSLATE: true,
  CF_TRANSLATE_MODEL: "@cf/qwen/qwen1.5-14b-chat-awq",
  CUSTOMER_MODEL_MAP: {
    "SD-1.5-Inpainting-CF": "@cf/runwayml/stable-diffusion-v1-5-inpainting",
    "DS-8-CF": "@cf/lykon/dreamshaper-8-lcm",
    "SD-XL-Bash-CF": "@cf/stabilityai/stable-diffusion-xl-base-1.0",
    "SD-XL-Lightning-CF": "@cf/bytedance/stable-diffusion-xl-lightning",
    "FLUX.1-Schnell-CF": "@cf/black-forest-labs/flux-1-schnell"
  },
  IMAGE_EXPIRATION: 60 * 30 // å›¾ç‰‡åœ¨ KV ä¸­çš„è¿‡æœŸæ—¶é—´ï¼ˆç§’ï¼‰ï¼Œè¿™é‡Œè®¾ç½®ä¸º 30 åˆ†é’Ÿ
};

// ä¸»å¤„ç†å‡½æ•°
async function handleRequest(request) {
  if (request.method === "OPTIONS") {
    return handleCORS();
  }

  if (!isAuthorized(request)) {
    return new Response("Unauthorized", { status: 401 });
  }

  const url = new URL(request.url);
  if (url.pathname.endsWith("/v1/models")) {
    return handleModelsRequest();
  }

  if (request.method !== "POST" || !url.pathname.endsWith("/v1/chat/completions")) {
    return new Response("Not Found", { status: 404 });
  }

  return handleChatCompletions(request);
}

// å¤„ç†CORSé¢„æ£€è¯·æ±‚
function handleCORS() {
  return new Response("", {
    status: 204,
    headers: {
      'Access-Control-Allow-Origin': '*',
      "Access-Control-Allow-Headers": '*'
    }
  });
}

// éªŒè¯æˆæƒ
function isAuthorized(request) {
  const authHeader = request.headers.get("Authorization");
  return authHeader &amp;&amp; authHeader.startsWith("Bearer ") &amp;&amp; authHeader.split(" ")[1] === CONFIG.API_KEY;
}

// å¤„ç†æ¨¡å‹åˆ—è¡¨è¯·æ±‚
function handleModelsRequest() {
  const models = Object.keys(CONFIG.CUSTOMER_MODEL_MAP).map(id =&gt; ({ id, object: "model" }));
  return new Response(JSON.stringify({ data: models, success: true }), {
    headers: {
      'Content-Type': 'application/json',
      'Access-Control-Allow-Origin': '*',
      'Access-Control-Allow-Headers': '*'
    }
  });
}

// å¤„ç†èŠå¤©å®Œæˆè¯·æ±‚
async function handleChatCompletions(request) {
  try {
    const data = await request.json();
    const { messages, model: requestedModel, stream } = data;
    const userMessage = messages.reverse().find(msg =&gt; msg.role === "user")?.content;

    if (!userMessage) {
      return new Response(JSON.stringify({ error: "æœªæ‰¾åˆ°ç”¨æˆ·æ¶ˆæ¯" }), { status: 400 });
    }

    const isTranslate = extractTranslate(userMessage);
    const originalPrompt = cleanPromptString(userMessage);
    let translatedPrompt;
    const model = CONFIG.CUSTOMER_MODEL_MAP[requestedModel] || CONFIG.CUSTOMER_MODEL_MAP["SD-XL-Lightning-CF"];

    if (model === CONFIG.CUSTOMER_MODEL_MAP["FLUX.1-Schnell-CF"]) {
      translatedPrompt = isTranslate ? await getFluxPrompt(originalPrompt) : originalPrompt; // ä½¿ç”¨ Flux æ¨¡å‹çš„ç¿»è¯‘æç¤ºè¯
    } else {
      translatedPrompt = isTranslate ? await getPrompt(originalPrompt) : originalPrompt; // ä½¿ç”¨å…¶ä»–æ¨¡å‹çš„ç¿»è¯‘æç¤ºè¯
    }

    let imageUrl;
    if (model === CONFIG.CUSTOMER_MODEL_MAP["FLUX.1-Schnell-CF"]) {
      imageUrl = await generateAndStoreFluxImage(model, translatedPrompt, request.url); // ä½¿ç”¨ Flux æ¨¡å‹ç”Ÿæˆå¹¶å­˜å‚¨å›¾åƒ
    } else {
      imageUrl = await generateAndStoreImage(model, translatedPrompt, request.url); // ä½¿ç”¨å…¶ä»–æ¨¡å‹ç”Ÿæˆå¹¶å­˜å‚¨å›¾åƒ
    }

    return stream ? 
      handleStreamResponse(originalPrompt, translatedPrompt, "1024x1024", model, imageUrl) :
      handleNonStreamResponse(originalPrompt, translatedPrompt, "1024x1024", model, imageUrl);
  } catch (error) {
    return new Response("Internal Server Error: " + error.message, { status: 500 });
  }
}

// è·å–ç¿»è¯‘åçš„æç¤ºè¯
async function getPrompt(prompt) {
  const requestBody = {
    messages: [
      {
        role: "system",
        content: `ä½œä¸º Stable Diffusion Prompt æç¤ºè¯ä¸“å®¶ï¼Œæ‚¨å°†ä»å…³é”®è¯ä¸­åˆ›å»ºæç¤ºï¼Œé€šå¸¸æ¥è‡ª Danbooru ç­‰æ•°æ®åº“ã€‚

        æç¤ºé€šå¸¸æè¿°å›¾åƒï¼Œä½¿ç”¨å¸¸è§è¯æ±‡ï¼ŒæŒ‰é‡è¦æ€§æ’åˆ—ï¼Œå¹¶ç”¨é€—å·åˆ†éš”ã€‚é¿å…ä½¿ç”¨"-"æˆ–"."ï¼Œä½†å¯ä»¥æ¥å—ç©ºæ ¼å’Œè‡ªç„¶è¯­è¨€ã€‚é¿å…è¯æ±‡é‡å¤ã€‚

        ä¸ºäº†å¼ºè°ƒå…³é”®è¯ï¼Œè¯·å°†å…¶æ”¾åœ¨æ‹¬å·ä¸­ä»¥å¢åŠ å…¶æƒé‡ã€‚ä¾‹å¦‚ï¼Œ"(flowers)"å°†'flowers'çš„æƒé‡å¢åŠ 1.1å€ï¼Œè€Œ"(((flowers)))"å°†å…¶å¢åŠ 1.331å€ã€‚ä½¿ç”¨"(flowers:1.5)"å°†'flowers'çš„æƒé‡å¢åŠ 1.5å€ã€‚åªä¸ºé‡è¦çš„æ ‡ç­¾å¢åŠ æƒé‡ã€‚

        æç¤ºåŒ…æ‹¬ä¸‰ä¸ªéƒ¨åˆ†ï¼š**å‰ç¼€** ï¼ˆè´¨é‡æ ‡ç­¾+é£æ ¼è¯+æ•ˆæœå™¨ï¼‰+ **ä¸»é¢˜** ï¼ˆå›¾åƒçš„ä¸»è¦ç„¦ç‚¹ï¼‰+ **åœºæ™¯** ï¼ˆèƒŒæ™¯ã€ç¯å¢ƒï¼‰ã€‚

        *   å‰ç¼€å½±å“å›¾åƒè´¨é‡ã€‚åƒ"masterpiece"ã€"best quality"ã€"4k"è¿™æ ·çš„æ ‡ç­¾å¯ä»¥æé«˜å›¾åƒçš„ç»†èŠ‚ã€‚åƒ"illustration"ã€"lensflare"è¿™æ ·çš„é£æ ¼è¯å®šä¹‰å›¾åƒçš„é£æ ¼ã€‚åƒ"bestlighting"ã€"lensflare"ã€"depthoffield"è¿™æ ·çš„æ•ˆæœå™¨ä¼šå½±å“å…‰ç…§å’Œæ·±åº¦ã€‚

        *   ä¸»é¢˜æ˜¯å›¾åƒçš„ä¸»è¦ç„¦ç‚¹ï¼Œå¦‚è§’è‰²æˆ–åœºæ™¯ã€‚å¯¹ä¸»é¢˜è¿›è¡Œè¯¦ç»†æè¿°å¯ä»¥ç¡®ä¿å›¾åƒä¸°å¯Œè€Œè¯¦ç»†ã€‚å¢åŠ ä¸»é¢˜çš„æƒé‡ä»¥å¢å¼ºå…¶æ¸…æ™°åº¦ã€‚å¯¹äºè§’è‰²ï¼Œæè¿°é¢éƒ¨ã€å¤´å‘ã€èº«ä½“ã€æœè£…ã€å§¿åŠ¿ç­‰ç‰¹å¾ã€‚

        *   åœºæ™¯æè¿°ç¯å¢ƒã€‚æ²¡æœ‰åœºæ™¯ï¼Œå›¾åƒçš„èƒŒæ™¯æ˜¯å¹³æ·¡çš„ï¼Œä¸»é¢˜æ˜¾å¾—è¿‡å¤§ã€‚æŸäº›ä¸»é¢˜æœ¬èº«åŒ…å«åœºæ™¯ï¼ˆä¾‹å¦‚å»ºç­‘ç‰©ã€é£æ™¯ï¼‰ã€‚åƒ"èŠ±è‰è‰åœ°"ã€"é˜³å…‰"ã€"æ²³æµ"è¿™æ ·çš„ç¯å¢ƒè¯å¯ä»¥ä¸°å¯Œåœºæ™¯ã€‚ä½ çš„ä»»åŠ¡æ˜¯è®¾è®¡å›¾åƒç”Ÿæˆçš„æç¤ºã€‚è¯·æŒ‰ç…§ä»¥ä¸‹æ­¥éª¤è¿›è¡Œæ“ä½œï¼š

        1.  æˆ‘ä¼šå‘é€ç»™æ‚¨ä¸€ä¸ªå›¾åƒåœºæ™¯ã€‚éœ€è¦ä½ ç”Ÿæˆè¯¦ç»†çš„å›¾åƒæè¿°
        2.  å›¾åƒæè¿°å¿…é¡»æ˜¯è‹±æ–‡ï¼Œè¾“å‡ºä¸ºPositive Promptã€‚

        ç¤ºä¾‹ï¼š

        æˆ‘å‘é€ï¼šäºŒæˆ˜æ—¶æœŸçš„æŠ¤å£«ã€‚
        æ‚¨å›å¤åªå›å¤ï¼š
        A WWII-era nurse in a German uniform, holding a wine bottle and stethoscope, sitting at a table in white attire, with a table in the background, masterpiece, best quality, 4k, illustration style, best lighting, depth of field, detailed character, detailed environment.`
      },
      { role: "user", content: prompt }
    ]
  };

  const response = await postRequest(CONFIG.CF_TRANSLATE_MODEL, requestBody);
  if (!response.ok) return prompt;

  const jsonResponse = await response.json();
  return jsonResponse.result.response;
}

// è·å– Flux æ¨¡å‹çš„ç¿»è¯‘åçš„æç¤ºè¯
async function getFluxPrompt(prompt) {
  const requestBody = {
    messages: [
      {
        role: "system",
        content: `ä½ æ˜¯ä¸€ä¸ªåŸºäºFlux.1æ¨¡å‹çš„æç¤ºè¯ç”Ÿæˆæœºå™¨äººã€‚æ ¹æ®ç”¨æˆ·çš„éœ€æ±‚ï¼Œè‡ªåŠ¨ç”Ÿæˆç¬¦åˆFlux.1æ ¼å¼çš„ç»˜ç”»æç¤ºè¯ã€‚è™½ç„¶ä½ å¯ä»¥å‚è€ƒæä¾›çš„æ¨¡æ¿æ¥å­¦ä¹ æç¤ºè¯ç»“æ„å’Œè§„å¾‹ï¼Œä½†ä½ å¿…é¡»å…·å¤‡çµæ´»æ€§æ¥åº”å¯¹å„ç§ä¸åŒéœ€æ±‚ã€‚æœ€ç»ˆè¾“å‡ºåº”ä»…é™æç¤ºè¯ï¼Œæ— éœ€ä»»ä½•å…¶ä»–è§£é‡Šæˆ–ä¿¡æ¯ã€‚ä½ çš„å›ç­”å¿…é¡»å…¨éƒ¨ä½¿ç”¨è‹±è¯­è¿›è¡Œå›å¤æˆ‘ï¼

### **æç¤ºè¯ç”Ÿæˆé€»è¾‘**ï¼š

1. **éœ€æ±‚è§£æ**ï¼šä»ç”¨æˆ·çš„æè¿°ä¸­æå–å…³é”®ä¿¡æ¯ï¼ŒåŒ…æ‹¬ï¼š
   - è§’è‰²ï¼šå¤–è²Œã€åŠ¨ä½œã€è¡¨æƒ…ç­‰ã€‚
   - åœºæ™¯ï¼šç¯å¢ƒã€å…‰çº¿ã€å¤©æ°”ç­‰ã€‚
   - é£æ ¼ï¼šè‰ºæœ¯é£æ ¼ã€æƒ…æ„Ÿæ°›å›´ã€é…è‰²ç­‰ã€‚
   - å…¶ä»–å…ƒç´ ï¼šç‰¹å®šç‰©å“ã€èƒŒæ™¯æˆ–ç‰¹æ•ˆã€‚

2. **æç¤ºè¯ç»“æ„è§„å¾‹**ï¼š
   - **ç®€æ´ã€ç²¾ç¡®ä¸”å…·è±¡**ï¼šæç¤ºè¯éœ€è¦ç®€å•ã€æ¸…æ™°åœ°æè¿°æ ¸å¿ƒå¯¹è±¡ï¼Œå¹¶åŒ…å«è¶³å¤Ÿç»†èŠ‚ä»¥å¼•å¯¼ç”Ÿæˆå‡ºç¬¦åˆéœ€æ±‚çš„å›¾åƒã€‚
   - **çµæ´»å¤šæ ·**ï¼šå‚è€ƒä¸‹åˆ—æ¨¡æ¿å’Œå·²æœ‰ç¤ºä¾‹ï¼Œä½†éœ€æ ¹æ®å…·ä½“éœ€æ±‚ç”Ÿæˆå¤šæ ·åŒ–çš„æç¤ºè¯ï¼Œé¿å…å›ºå®šåŒ–æˆ–è¿‡äºä¾èµ–æ¨¡æ¿ã€‚
   - **ç¬¦åˆFlux.1é£æ ¼çš„æè¿°**ï¼šæç¤ºè¯å¿…é¡»éµå¾ªFlux.1çš„è¦æ±‚ï¼Œå°½é‡åŒ…å«è‰ºæœ¯é£æ ¼ã€è§†è§‰æ•ˆæœã€æƒ…æ„Ÿæ°›å›´çš„æè¿°ï¼Œä½¿ç”¨ä¸Flux.1æ¨¡å‹ç”Ÿæˆç›¸ç¬¦çš„å…³é”®è¯å’Œæè¿°æ¨¡å¼ã€‚

3. **ä»…ä¾›ä½ å‚è€ƒå’Œå­¦ä¹ çš„å‡ ç§åœºæ™¯æç¤ºè¯**ï¼ˆä½ éœ€è¦å­¦ä¹ å¹¶çµæ´»è°ƒæ•´,"[ ]"ä¸­å†…å®¹è§†ç”¨æˆ·é—®é¢˜è€Œå®šï¼‰ï¼š
   - **è§’è‰²è¡¨æƒ…é›†**ï¼š
åœºæ™¯è¯´æ˜ï¼šé€‚åˆåŠ¨ç”»æˆ–æ¼«ç”»åˆ›ä½œè€…ä¸ºè§’è‰²è®¾è®¡å¤šæ ·çš„è¡¨æƒ…ã€‚è¿™äº›æç¤ºè¯å¯ä»¥ç”Ÿæˆå±•ç¤ºåŒä¸€è§’è‰²åœ¨ä¸åŒæƒ…ç»ªä¸‹çš„è¡¨æƒ…é›†ï¼Œæ¶µç›–å¿«ä¹ã€æ‚²ä¼¤ã€æ„¤æ€’ç­‰å¤šç§æƒ…æ„Ÿã€‚

æç¤ºè¯ï¼šAn anime [SUBJECT], animated expression reference sheet, character design, reference sheet, turnaround, lofi style, soft colors, gentle natural linework, key art, range of emotions, happy sad mad scared nervous embarrassed confused neutral, hand drawn, award winning anime, fully clothed

[SUBJECT] character, animation expression reference sheet with several good animation expressions featuring the same character in each one, showing different faces from the same person in a grid pattern: happy sad mad scared nervous embarrassed confused neutral, super minimalist cartoon style flat muted kawaii pastel color palette, soft dreamy backgrounds, cute round character designs, minimalist facial features, retro-futuristic elements, kawaii style, space themes, gentle line work, slightly muted tones, simple geometric shapes, subtle gradients, oversized clothing on characters, whimsical, soft puffy art, pastels, watercolor

   - **å…¨è§’åº¦è§’è‰²è§†å›¾**ï¼š
åœºæ™¯è¯´æ˜ï¼šå½“éœ€è¦ä»ç°æœ‰è§’è‰²è®¾è®¡ä¸­ç”Ÿæˆä¸åŒè§’åº¦çš„å…¨èº«å›¾æ—¶ï¼Œå¦‚æ­£é¢ã€ä¾§é¢å’ŒèƒŒé¢ï¼Œé€‚ç”¨äºè§’è‰²è®¾è®¡ç»†åŒ–æˆ–åŠ¨ç”»å»ºæ¨¡ã€‚

æç¤ºè¯ï¼šA character sheet of [SUBJECT] in different poses and angles, including front view, side view, and back view

   - **80 å¹´ä»£å¤å¤é£æ ¼**ï¼š
åœºæ™¯è¯´æ˜ï¼šé€‚åˆå¸Œæœ›åˆ›é€  80 å¹´ä»£å¤å¤é£æ ¼ç…§ç‰‡æ•ˆæœçš„è‰ºæœ¯å®¶æˆ–è®¾è®¡å¸ˆã€‚è¿™äº›æç¤ºè¯å¯ä»¥ç”Ÿæˆå¸¦æœ‰æ€€æ—§æ„Ÿçš„æ¨¡ç³Šå®ä¸½æ¥é£æ ¼ç…§ç‰‡ã€‚

æç¤ºè¯ï¼šblurry polaroid of [a simple description of the scene], 1980s.

   - **æ™ºèƒ½æ‰‹æœºå†…éƒ¨å±•ç¤º**ï¼š
åœºæ™¯è¯´æ˜ï¼šé€‚åˆéœ€è¦å±•ç¤ºæ™ºèƒ½æ‰‹æœºç­‰äº§å“è®¾è®¡çš„ç§‘æŠ€åšå®¢ä½œè€…æˆ–äº§å“è®¾è®¡å¸ˆã€‚è¿™äº›æç¤ºè¯å¸®åŠ©ç”Ÿæˆå±•ç¤ºæ‰‹æœºå¤–è§‚å’Œå±å¹•å†…å®¹çš„å›¾åƒã€‚

æç¤ºè¯ï¼ša iphone product image showing the iphone standing and inside the screen the image is shown

   - **åŒé‡æ›å…‰æ•ˆæœ**ï¼š
åœºæ™¯è¯´æ˜ï¼šé€‚åˆæ‘„å½±å¸ˆæˆ–è§†è§‰è‰ºæœ¯å®¶é€šè¿‡åŒé‡æ›å…‰æŠ€æœ¯åˆ›é€ æ·±åº¦å’Œæƒ…æ„Ÿè¡¨è¾¾çš„è‰ºæœ¯ä½œå“ã€‚

æç¤ºè¯ï¼š[Abstract style waterfalls, wildlife] inside the silhouette of a [man]â€™s head that is a double exposure photograph . Non-representational, colors and shapes, expression of feelings, imaginative, highly detailed

   - **é«˜è´¨æ„Ÿç”µå½±æµ·æŠ¥**ï¼š
åœºæ™¯è¯´æ˜ï¼šé€‚åˆéœ€è¦ä¸ºç”µå½±åˆ›å»ºå¼•äººæ³¨ç›®æµ·æŠ¥çš„ç”µå½±å®£ä¼ æˆ–å¹³é¢è®¾è®¡å¸ˆã€‚

æç¤ºè¯ï¼šA digital illustration of a movie poster titled [â€˜Sad Sax: Fury Toadâ€™], [Mad Max] parody poster, featuring [a saxophone-playing toad in a post-apocalyptic desert, with a customized car made of musical instruments], in the background, [a wasteland with other musical vehicle chases], movie title in [a gritty, bold font, dusty and intense color palette].

   - **é•œé¢è‡ªæ‹æ•ˆæœ**ï¼š
åœºæ™¯è¯´æ˜ï¼šé€‚åˆæƒ³è¦æ•æ‰æ—¥å¸¸ç”Ÿæ´»ç¬é—´çš„æ‘„å½±å¸ˆæˆ–ç¤¾äº¤åª’ä½“ç”¨æˆ·ã€‚

æç¤ºè¯ï¼šPhone photo: A woman stands in front of a mirror, capturing a selfie. The image quality is grainy, with a slight blur softening the details. The lighting is dim, casting shadows that obscure her features. [The room is cluttered, with clothes strewn across the bed and an unmade blanket. Her expression is casual, full of concentration], while the old iPhone struggles to focus, giving the photo an authentic, unpolished feel. The mirror shows smudges and fingerprints, adding to the raw, everyday atmosphere of the scene.

   - **åƒç´ è‰ºæœ¯åˆ›ä½œ**ï¼š
åœºæ™¯è¯´æ˜ï¼šé€‚åˆåƒç´ è‰ºæœ¯çˆ±å¥½è€…æˆ–å¤å¤æ¸¸æˆå¼€å‘è€…åˆ›é€ æˆ–å¤åˆ»ç»å…¸åƒç´ é£æ ¼å›¾åƒã€‚

æç¤ºè¯ï¼š[Anything you want] pixel art style, pixels, pixel art

   - **ä»¥ä¸Šéƒ¨åˆ†åœºæ™¯ä»…ä¾›ä½ å­¦ä¹ ï¼Œä¸€å®šè¦å­¦ä¼šçµæ´»å˜é€šï¼Œä»¥é€‚åº”ä»»ä½•ç»˜ç”»éœ€æ±‚**ï¼š

4. **Flux.1æç¤ºè¯è¦ç‚¹æ€»ç»“**ï¼š
   - **ç®€æ´ç²¾å‡†çš„ä¸»ä½“æè¿°**ï¼šæ˜ç¡®å›¾åƒä¸­æ ¸å¿ƒå¯¹è±¡çš„èº«ä»½æˆ–åœºæ™¯ã€‚
   - **é£æ ¼å’Œæƒ…æ„Ÿæ°›å›´çš„å…·ä½“æè¿°**ï¼šç¡®ä¿æç¤ºè¯åŒ…å«è‰ºæœ¯é£æ ¼ã€å…‰çº¿ã€é…è‰²ã€ä»¥åŠå›¾åƒçš„æ°›å›´ç­‰ä¿¡æ¯ã€‚
   - **åŠ¨æ€ä¸ç»†èŠ‚çš„è¡¥å……**ï¼šæç¤ºè¯å¯åŒ…æ‹¬åœºæ™¯ä¸­çš„åŠ¨ä½œã€æƒ…ç»ªã€æˆ–å…‰å½±æ•ˆæœç­‰é‡è¦ç»†èŠ‚ã€‚
   - **å…¶ä»–æ›´å¤šè§„å¾‹è¯·è‡ªå·±å¯»æ‰¾**
---

**é—®ç­”æ¡ˆä¾‹1**ï¼š
**ç”¨æˆ·è¾“å…¥**ï¼šä¸€ä¸ª80å¹´ä»£å¤å¤é£æ ¼çš„ç…§ç‰‡ã€‚
**ä½ çš„è¾“å‡º**ï¼šA blurry polaroid of a 1980s living room, with vintage furniture, soft pastel tones, and a nostalgic, grainy texture,  The sunlight filters through old curtains, casting long, warm shadows on the wooden floor, 1980s,

**é—®ç­”æ¡ˆä¾‹2**ï¼š
**ç”¨æˆ·è¾“å…¥**ï¼šä¸€ä¸ªèµ›åšæœ‹å…‹é£æ ¼çš„å¤œæ™šåŸå¸‚èƒŒæ™¯
**ä½ çš„è¾“å‡º**ï¼šA futuristic cityscape at night, in a cyberpunk style, with neon lights reflecting off wet streets, towering skyscrapers, and a glowing, high-tech atmosphere. Dark shadows contrast with vibrant neon signs, creating a dramatic, dystopian mood`
      },
      { role: "user", content: prompt }
    ]
  };

  const response = await postRequest(CONFIG.CF_TRANSLATE_MODEL, requestBody);
  if (!response.ok) return prompt;

  const jsonResponse = await response.json();
  return jsonResponse.result.response;
}

// ç”Ÿæˆå›¾åƒå¹¶å­˜å‚¨åˆ° KV
async function generateAndStoreImage(model, prompt, requestUrl) {
  try {
    const jsonBody = { prompt, num_steps: 20, guidance: 7.5, strength: 1, width: 1024, height: 1024 };
    const response = await postRequest(model, jsonBody);
    const imageBuffer = await response.arrayBuffer();

    // ç”Ÿæˆå”¯ä¸€çš„é”®
    const key = `image_${Date.now()}_${Math.random().toString(36).substring(7)}`;
    
    // å­˜å‚¨å›¾ç‰‡åˆ° KV
    await IMAGE_KV.put(key, imageBuffer, {
      expirationTtl: CONFIG.IMAGE_EXPIRATION,
      metadata: { contentType: 'image/png' }
    });

    // æ„å»ºå¹¶è¿”å›å›¾ç‰‡ URL
    const imageUrl = `${new URL(requestUrl).origin}/image/${key}`;
    return imageUrl;
  } catch (error) {
    throw new Error("å›¾åƒç”Ÿæˆå¤±è´¥ï¼Œè¯·æ£€æŸ¥ï¼" + error.message);
  }
}

// ä½¿ç”¨ Flux æ¨¡å‹ç”Ÿæˆå¹¶å­˜å‚¨å›¾åƒ
async function generateAndStoreFluxImage(model, prompt, requestUrl) {
  try {
    const jsonBody = { prompt, num_steps: 4 }; // Flux æ¨¡å‹çš„è¯·æ±‚å‚æ•°
    const response = await postRequest(model, jsonBody);
    const jsonResponse = await response.json();
    const base64ImageData = jsonResponse.result.image; // è·å– base64 ç¼–ç çš„å›¾åƒæ•°æ®

    // å°† base64 æ•°æ®è½¬æ¢ä¸º ArrayBuffer
    const imageBuffer = base64ToArrayBuffer(base64ImageData);

    // ç”Ÿæˆå”¯ä¸€çš„é”®
    const key = `image_${Date.now()}_${Math.random().toString(36).substring(7)}`;

    // å­˜å‚¨å›¾ç‰‡åˆ° KV
    await IMAGE_KV.put(key, imageBuffer, {
      expirationTtl: CONFIG.IMAGE_EXPIRATION,
      metadata: { contentType: 'image/png' }
    });

    // æ„å»ºå¹¶è¿”å›å›¾ç‰‡ URL
    const imageUrl = `${new URL(requestUrl).origin}/image/${key}`;
    return imageUrl;
  } catch (error) {
    throw new Error("å›¾åƒç”Ÿæˆå¤±è´¥ï¼Œè¯·æ£€æŸ¥ï¼" + error.message);
  }
}

// å¤„ç†æµå¼å“åº”
function handleStreamResponse(originalPrompt, translatedPrompt, size, model, imageUrl) {
  const content = generateResponseContent(originalPrompt, translatedPrompt, size, imageUrl);
  const responsePayload = {
    id: `chatcmpl-${Date.now()}`,
    object: "chat.completion.chunk",
    created: Math.floor(Date.now() / 1000),
    model: model,
    system_fingerprint: "fp_" + Math.random().toString(36).substr(2, 9),
    choices: [
      {
        index: 0,
        delta: { content },
        finish_reason: "stop",
      },
    ],
  };

  return new Response(`data: ${JSON.stringify(responsePayload)}\n\ndata: [DONE]\n\n`, {
    headers: {
      "Content-Type": "text/event-stream",
      'Access-Control-Allow-Origin': '*',
      "Access-Control-Allow-Headers": '*',
    },
  });
}

// å¤„ç†éæµå¼å“åº”
function handleNonStreamResponse(originalPrompt, translatedPrompt, size, model, imageUrl) {
  const content = generateResponseContent(originalPrompt, translatedPrompt, size, imageUrl);
  const response = {
    id: `chatcmpl-${Date.now()}`,
    object: "chat.completion",
    created: Math.floor(Date.now() / 1000),
    model: model,
    system_fingerprint: "fp_" + Math.random().toString(36).substr(2, 9),
    choices: [{
      index: 0,
      message: { role: "assistant", content },
      finish_reason: "stop"
    }],
    usage: {
      prompt_tokens: translatedPrompt.length,
      completion_tokens: content.length,
      total_tokens: translatedPrompt.length + content.length
    }
  };

  return new Response(JSON.stringify(response), {
    headers: {
      'Content-Type': 'application/json',
      'Access-Control-Allow-Origin': '*',
      'Access-Control-Allow-Headers': '*'
    }
  });
}

// ç”Ÿæˆå“åº”å†…å®¹
function generateResponseContent(originalPrompt, translatedPrompt, size, imageUrl) {
  return `ğŸ¨ åŸå§‹æç¤ºè¯ï¼š${originalPrompt}\n` +
         `ğŸŒ ç¿»è¯‘åçš„æç¤ºè¯ï¼š${translatedPrompt}\n` +
         `ğŸ“ å›¾åƒè§„æ ¼ï¼š${size}\n` +
         `ğŸŒŸ å›¾åƒç”ŸæˆæˆåŠŸï¼\n` +
         `ä»¥ä¸‹æ˜¯ç»“æœï¼š\n\n` +
         `![ç”Ÿæˆçš„å›¾åƒ](${imageUrl})`;
}

// å‘é€POSTè¯·æ±‚
async function postRequest(model, jsonBody) {
  const cf_account = CONFIG.CF_ACCOUNT_LIST[Math.floor(Math.random() * CONFIG.CF_ACCOUNT_LIST.length)];
  const apiUrl = `https://api.cloudflare.com/client/v4/accounts/${cf_account.account_id}/ai/run/${model}`;
  const response = await fetch(apiUrl, {
    method: 'POST',
    headers: {
      'Authorization': `Bearer ${cf_account.token}`,
      'Content-Type': 'application/json'
    },
    body: JSON.stringify(jsonBody)
  });

  if (!response.ok) {
    throw new Error('Unexpected response ' + response.status);
  }
  return response;
}

// æå–ç¿»è¯‘æ ‡å¿—
function extractTranslate(prompt) {
  const match = prompt.match(/---n?tl/);
  if (match &amp;&amp; match[0]) {
    return match[0] === "---tl";
  }
  return CONFIG.CF_IS_TRANSLATE;
}

// æ¸…ç†æç¤ºè¯å­—ç¬¦ä¸²
function cleanPromptString(prompt) {
  return prompt.replace(/---n?tl/, "").trim();
}

// å¤„ç†å›¾ç‰‡è¯·æ±‚
async function handleImageRequest(request) {
  const url = new URL(request.url);
  const key = url.pathname.split('/').pop();
  
  const imageData = await IMAGE_KV.get(key, 'arrayBuffer');
  if (!imageData) {
    return new Response('Image not found', { status: 404 });
  }

  return new Response(imageData, {
    headers: {
      'Content-Type': 'image/png',
      'Cache-Control': 'public, max-age=604800',
    },
  });
}

// base64 å­—ç¬¦ä¸²è½¬æ¢ä¸º ArrayBuffer
function base64ToArrayBuffer(base64) {
  const binaryString = atob(base64);
  const len = binaryString.length;
  const bytes = new Uint8Array(len);
  for (let i = 0; i &lt; len; i++) {
    bytes[i] = binaryString.charCodeAt(i);
  }
  return bytes.buffer;
}

addEventListener('fetch', event =&gt; {
  const url = new URL(event.request.url);
  if (url.pathname.startsWith('/image/')) {
    event.respondWith(handleImageRequest(event.request));
  } else {
    event.respondWith(handleRequest(event.request));
  }
});</pre>
<h2>ä¿å­˜å’Œæ„å»º</h2>
<p>ctrl+s ä¿å­˜ï¼Œ ç„¶åå³ä¸Šè§’çš„deployæ„å»ºå³å¯ã€‚</p>
<p><img src="img/97551b5b902347f5d92e17c5e8bb9c9a.png" data-original-src="https://internal-api-drive-stream.feishu.cn/space/api/box/stream/download/v2/cover/KOCIbXT0Jou1KkxNjbxcWbZMnkf/"/></p>

<h2>ç»‘å®škv</h2>
<p>é€‰æ‹©è¿™ä¸ªworkï¼Œç‚¹å‡»settingsï¼Œä¸‹é¢çš„ç»‘å®šï¼Œé€‰æ‹©ç¬¬å››éƒ¨é‡Œé¢çš„kvå³å¯</p>
<p><img src="img/a65239747a9c997fe2cafd4c788ad378.png" data-original-src="https://internal-api-drive-stream.feishu.cn/space/api/box/stream/download/v2/cover/RSr4beaujonoVixHvjKcGo58nqF/"/></p>

<p>å¤§å·¥ææˆã€‚</p>
<p>æœ€åç‚¹å‡»worker é¡µé¢ï¼Œé“¾æ¥åœ°å€å°±æ˜¯ï¼Œä¸‹é¢è¿™ä¸ªvisitè®¿é—®ï¼š</p>
<p><img src="img/171ddb3e8cbd793b7a79fbd656c0ca15.png" data-original-src="https://internal-api-drive-stream.feishu.cn/space/api/box/stream/download/v2/cover/QpV1bgjU6o3lz0xAJzZcIIMDnEc/"/></p>

<p>åº”è¯¥æ˜¯ç±»ä¼¼è¿™æ ·çš„ï¼šhttps://flux-cf.xxd123123123.workers.dev/</p>
<h1>ä½¿ç”¨FLux</h1>
<p>æœ‰å¾ˆå¤šéƒ½æ˜¯å°è£…ä¸ºopenaiçš„é€šç”¨æ¥å£ã€‚</p>
<p>ç›´æ¥å¯ä»¥ç”¨å·²ç»æœ‰çš„å·¥å…·æ¥è®¿é—®å’Œè°ƒç”¨å³å¯ã€‚</p>

<h2>æ‰“å¼€ chat  box</h2>
<p>æ¯”å¦‚è¿™é‡Œ ç”¨ï¼š https://web.chatboxai.app/</p>
<h2>ç‚¹å‡»è®¾ç½®</h2>
<p><img src="img/8386d191cd362e153b382aa31d30cd89.png" data-original-src="https://internal-api-drive-stream.feishu.cn/space/api/box/stream/download/v2/cover/RbMjbLCQUoQkyJxrFTqcBFV0nkb/"/></p>
<h2>é…ç½®APIå’Œurl</h2>
<p>é€‰æ‹©è‡ªå®šä¹‰ï¼š</p>
<p><img src="img/41d961b492cdcd0b833e8ae4053d7344.png" data-original-src="https://internal-api-drive-stream.feishu.cn/space/api/box/stream/download/v2/cover/CQqtbY3YqoGp3kxepp5cnV8MnNd/"/></p>
<p>ä¿®æ”¹å¦‚ä¸‹ï¼Œçº¢è‰²çš„éœ€è¦ä¿®æ”¹ï¼Œname, api host, api key, model .</p>
<p>Api hostå’Œapi keyå’Œnameæ˜¯è‡ªå·±çš„ï¼Œ å…¶ä»–å‡ ä¸ªå€¼ç†è®ºä¸Šåº”è¯¥éƒ½éœ€è¦ä¸€è‡´ã€‚ï¼Œç‚¹å‡»ä¿å­˜å³å¯</p>
<p><img src="img/2f1d13bc1f49917b2319bb33a1c66515.png" data-original-src="https://internal-api-drive-stream.feishu.cn/space/api/box/stream/download/v2/cover/HNLtb7BYDoY9wzx8Y97cfzf7nJd/"/></p>

<p>æµ‹è¯•ä¸‹æ•ˆæœï¼š</p>
<p>å‘é€ï¼š a cure cartoon kitty</p>
<p><img src="img/141bfb4a641c93fd9b0a5d9f0cac7152.png" data-original-src="https://internal-api-drive-stream.feishu.cn/space/api/box/stream/download/v2/cover/N4slbG6TMoffDBx0515cANJMnPi/"/></p>
